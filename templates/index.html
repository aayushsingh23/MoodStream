<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodStream - Emotion-Based Music Recommendation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>üéµ MoodStream</h1>
        <p class="subtitle">Get personalized music recommendations based on your emotions</p>

        <div class="options-container">
            <div class="option-card">
                <h2>Auto Detect Emotion</h2>
                <p>Let our AI detect your emotion from your camera</p>
                <button id="detectEmotion" class="primary-btn">
                    <span class="btn-icon">üé≠</span>
                    Detect My Emotion
                </button>
            </div>

            <div class="divider">OR</div>

            <div class="option-card">
                <h2>Select Your Mood</h2>
                <p>Choose how you're feeling right now</p>
                <div class="emotion-grid">
                    <button class="emotion-btn" data-emotion="Happy">
                        <span class="emotion-icon">üòä</span>
                        Happy
                    </button>
                    <button class="emotion-btn" data-emotion="Sad">
                        <span class="emotion-icon">üò¢</span>
                        Sad
                    </button>
                    <button class="emotion-btn" data-emotion="Angry">
                        <span class="emotion-icon">üò†</span>
                        Angry
                    </button>
                    <button class="emotion-btn" data-emotion="Relaxed">
                        <span class="emotion-icon">üòå</span>
                        Relaxed
                    </button>
                    <button class="emotion-btn" data-emotion="Surprise">
                        <span class="emotion-icon">üò≤</span>
                        Surprised
                    </button>
                    <button class="emotion-btn" data-emotion="Anxious">
                        <span class="emotion-icon">üò∞</span>
                        Anxious
                    </button>
                </div>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Finding perfect songs for you...</p>
        </div>

        <div id="result" class="result-section hidden"></div>
    </div>

    <script>
        $(document).ready(function () {
            // Auto detect emotion
            $("#detectEmotion").click(function () {
                showLoading("Detecting your emotion...");

                $.ajax({
                    url: "/detect-emotion-and-recommend",
                    type: "POST",
                    dataType: "json",
                    success: function (data) {
                        hideLoading();
                        if (data.error) {
                            showError(data.error);
                        } else {
                            showResults(data.emotion, data.songs, "detected");
                        }
                    },
                    error: function (xhr, status, error) {
                        hideLoading();
                        showError("Failed to detect emotion. Please try again.");
                    }
                });
            });

            // Manual emotion selection
            $(".emotion-btn").click(function () {
                const selectedEmotion = $(this).data("emotion");

                // Visual feedback
                $(".emotion-btn").removeClass("selected");
                $(this).addClass("selected");

                showLoading(`Finding ${selectedEmotion.toLowerCase()} songs...`);

                $.ajax({
                    url: "/select-emotion-and-recommend",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ emotion: selectedEmotion }),
                    dataType: "json",
                    success: function (data) {
                        hideLoading();
                        if (data.error) {
                            showError(data.error);
                        } else {
                            showResults(data.emotion, data.songs, "selected");
                        }
                    },
                    error: function (xhr, status, error) {
                        hideLoading();
                        showError("Failed to get recommendations. Please try again.");
                    }
                });
            });

            function showLoading(message = "Processing...") {
                $("#loading p").text(message);
                $("#loading").removeClass("hidden");
                $("#result").addClass("hidden");
            }

            function hideLoading() {
                $("#loading").addClass("hidden");
            }

            function showError(message) {
                $("#result").removeClass("hidden");
                $("#result").html(`
                    <div class="error-message">
                        <span class="error-icon">‚ö†Ô∏è</span>
                        <h3>Oops! Something went wrong</h3>
                        <p>${message}</p>
                    </div>
                `);
            }

            function showResults(emotion, songs, method) {
                const methodText = method === "detected" ? "Detected" : "Selected";

                // Hide the options containers
                $(".options-container").addClass("hidden");

                $("#result").removeClass("hidden");
                $("#result").html(`
                    <div class="results-container">
                        <div class="emotion-result">
                            <h2>${methodText} Emotion: ${emotion}</h2>
                        </div>
                        <div class="songs-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0;">Recommended Songs for You</h3>
                                <button id="emailPlaylistBtn" class="secondary-btn" onclick="showEmailModal('${emotion}')">
                                    üìß Email Spotify Discovery Link
                                </button>
                            </div>
                            <div class="songs-grid">
                                ${songs.map((song, index) => `
                                    <div class="song-card">
                                        <div class="song-number">${index + 1}</div>
                                        <div class="song-info">
                                            <a href="${song[1]}" target="_blank" class="song-link">
                                                <div class="song-title">${song[0]}</div>
                                                <div class="song-action">‚ñ∂ Play on Spotify</div>
                                            </a>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button id="tryAgainBtn" class="try-again-btn">
                                <span class="btn-text">Try Again</span>
                                <span class="btn-subtitle">Get new recommendations</span>
                            </button>
                        </div>
                    </div>
                `);

                // Add click handler for try again button
                $("#tryAgainBtn").click(function () {
                    // Hide results
                    $("#result").addClass("hidden");
                    // Show options containers again
                    $(".options-container").removeClass("hidden");
                    // Remove selection from emotion buttons
                    $(".emotion-btn").removeClass("selected");
                });

                // Remove selection from emotion buttons
                $(".emotion-btn").removeClass("selected");
            }
        });

        // Email functionality
        function showEmailModal(emotion) {
            const modal = document.createElement('div');
            modal.id = 'emailModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="
                    background: #121212;
                    padding: 30px;
                    border-radius: 15px;
                    width: 90%;
                    max-width: 400px;
                    text-align: center;
                    border: 2px solid #1DB954;
                ">
                    <h3 style="color: #1DB954; margin-bottom: 20px;">üìß Get Spotify Discovery Link</h3>
                    <p style="color: #B3B3B3; margin-bottom: 20px;">
                        We'll send you a curated Spotify link plus your <strong>${emotion}</strong> song recommendations!
                    </p>
                    <input 
                        type="email" 
                        id="userEmail" 
                        placeholder="Enter your email address"
                        style="
                            width: 100%;
                            padding: 12px;
                            margin-bottom: 20px;
                            border: 2px solid #404040;
                            border-radius: 8px;
                            background: #1a1a1a;
                            color: #FFFFFF;
                            font-size: 16px;
                            box-sizing: border-box;
                        "
                    >
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button 
                            onclick="sendEmailPlaylist('${emotion}')" 
                            style="
                                background: #1DB954;
                                color: #000000;
                                border: none;
                                padding: 12px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            "
                        >
                            Send Discovery Link
                        </button>
                        <button 
                            onclick="closeEmailModal()" 
                            style="
                                background: #404040;
                                color: #FFFFFF;
                                border: none;
                                padding: 12px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                            "
                        >
                            Cancel
                        </button>
                    </div>
                    <div id="emailStatus" style="margin-top: 15px;"></div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('userEmail').focus();
        }

        function closeEmailModal() {
            const modal = document.getElementById('emailModal');
            if (modal) {
                modal.remove();
            }
        }

        function sendEmailPlaylist(emotion) {
            const email = document.getElementById('userEmail').value.trim();
            const statusDiv = document.getElementById('emailStatus');

            if (!email) {
                statusDiv.innerHTML = '<p style="color: #FF6B6B;">Please enter your email address</p>';
                return;
            }

            if (!email.includes('@') || !email.includes('.')) {
                statusDiv.innerHTML = '<p style="color: #FF6B6B;">Please enter a valid email address</p>';
                return;
            }

            statusDiv.innerHTML = '<p style="color: #1DB954;">üì§ Sending your playlist...</p>';

            $.ajax({
                url: '/send-email-playlist',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    email: email,
                    emotion: emotion
                }),
                success: function (response) {
                    statusDiv.innerHTML = `<p style="color: #1DB954;">‚úÖ ${response.message}</p>`;
                    setTimeout(() => {
                        closeEmailModal();
                    }, 2000);
                },
                error: function (xhr, status, error) {
                    let errorMsg = 'Failed to send email. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå ${errorMsg}</p>`;
                }
            });
        }

        // Close modal when clicking outside
        $(document).on('click', '#emailModal', function (e) {
            if (e.target.id === 'emailModal') {
                closeEmailModal();
            }
        });

        // Handle Enter key in email input
        $(document).on('keypress', '#userEmail', function (e) {
            if (e.which === 13) {
                const emotion = document.querySelector('#emailModal button[onclick*="sendEmailPlaylist"]')
                    .getAttribute('onclick').match(/'([^']+)'/)[1];
                sendEmailPlaylist(emotion);
            }
        });
    </script>
</body>

</html>